# è´­ç‰©è½¦æ•°æ®åŒæ­¥å®ç°ç¤ºä¾‹

## ğŸ“‹ æ¦‚è¿°

å½“å‰è´­ç‰©è½¦æ•°æ®åªä¿å­˜åœ¨å‰ç«¯çš„localStorageä¸­ï¼Œç”¨æˆ·åœ¨ä¸åŒè®¾å¤‡ç™»å½•æ—¶æ— æ³•çœ‹åˆ°ä¹‹å‰çš„è´­ç‰©è½¦å†…å®¹ã€‚æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„è´­ç‰©è½¦æ•°æ®åŒæ­¥å®ç°æ–¹æ¡ˆã€‚

## ğŸ”§ åç«¯å®ç°

### 1. åˆ›å»ºè´­ç‰©è½¦å®ä½“ç±»

```java
// src/main/java/com/taobao/entity/CartItem.java
package com.taobao.entity;

import javax.persistence.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "cart_items")
public class CartItem {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @ManyToOne
    @JoinColumn(name = "customer_id")
    private Customer customer;
    
    @ManyToOne
    @JoinColumn(name = "product_id")
    private Product product;
    
    private Integer quantity;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    
    // æ„é€ å‡½æ•°
    public CartItem() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }
    
    // Getters and Setters
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public Customer getCustomer() { return customer; }
    public void setCustomer(Customer customer) { this.customer = customer; }
    
    public Product getProduct() { return product; }
    public void setProduct(Product product) { this.product = product; }
    
    public Integer getQuantity() { return quantity; }
    public void setQuantity(Integer quantity) { 
        this.quantity = quantity;
        this.updatedAt = LocalDateTime.now();
    }
    
    public LocalDateTime getCreatedAt() { return createdAt; }
    public LocalDateTime getUpdatedAt() { return updatedAt; }
}
```

### 2. åˆ›å»ºè´­ç‰©è½¦ä»“åº“æ¥å£

```java
// src/main/java/com/taobao/repository/CartItemRepository.java
package com.taobao.repository;

import com.taobao.entity.CartItem;
import com.taobao.entity.Customer;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface CartItemRepository extends JpaRepository<CartItem, Long> {
    
    List<CartItem> findByCustomer(Customer customer);
    
    Optional<CartItem> findByCustomerAndProduct_Id(Customer customer, Long productId);
    
    @Modifying
    @Query("DELETE FROM CartItem c WHERE c.customer = ?1")
    void deleteByCustomer(Customer customer);
    
    @Modifying
    @Query("DELETE FROM CartItem c WHERE c.customer = ?1 AND c.product.id = ?2")
    void deleteByCustomerAndProductId(Customer customer, Long productId);
}
```

### 3. åˆ›å»ºè´­ç‰©è½¦æœåŠ¡

```java
// src/main/java/com/taobao/service/CartService.java
package com.taobao.service;

import com.taobao.entity.CartItem;
import com.taobao.entity.Customer;
import com.taobao.entity.Product;
import com.taobao.repository.CartItemRepository;
import com.taobao.repository.CustomerRepository;
import com.taobao.repository.ProductRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Optional;

@Service
@Transactional
public class CartService {
    
    @Autowired
    private CartItemRepository cartItemRepository;
    
    @Autowired
    private CustomerRepository customerRepository;
    
    @Autowired
    private ProductRepository productRepository;
    
    public List<CartItem> getCartItems(Long customerId) {
        Optional<Customer> customer = customerRepository.findById(customerId);
        if (customer.isPresent()) {
            return cartItemRepository.findByCustomer(customer.get());
        }
        throw new RuntimeException("Customer not found");
    }
    
    public CartItem addToCart(Long customerId, Long productId, Integer quantity) {
        Optional<Customer> customer = customerRepository.findById(customerId);
        Optional<Product> product = productRepository.findById(productId);
        
        if (customer.isPresent() && product.isPresent()) {
            Optional<CartItem> existingItem = cartItemRepository
                    .findByCustomerAndProduct_Id(customer.get(), productId);
            
            if (existingItem.isPresent()) {
                // æ›´æ–°æ•°é‡
                CartItem item = existingItem.get();
                item.setQuantity(item.getQuantity() + quantity);
                return cartItemRepository.save(item);
            } else {
                // åˆ›å»ºæ–°çš„è´­ç‰©è½¦é¡¹
                CartItem newItem = new CartItem();
                newItem.setCustomer(customer.get());
                newItem.setProduct(product.get());
                newItem.setQuantity(quantity);
                return cartItemRepository.save(newItem);
            }
        }
        throw new RuntimeException("Customer or Product not found");
    }
    
    public CartItem updateCartItem(Long customerId, Long productId, Integer quantity) {
        Optional<Customer> customer = customerRepository.findById(customerId);
        if (customer.isPresent()) {
            Optional<CartItem> cartItem = cartItemRepository
                    .findByCustomerAndProduct_Id(customer.get(), productId);
            
            if (cartItem.isPresent()) {
                CartItem item = cartItem.get();
                item.setQuantity(quantity);
                return cartItemRepository.save(item);
            }
        }
        throw new RuntimeException("Cart item not found");
    }
    
    public void removeFromCart(Long customerId, Long productId) {
        Optional<Customer> customer = customerRepository.findById(customerId);
        if (customer.isPresent()) {
            cartItemRepository.deleteByCustomerAndProductId(customer.get(), productId);
        }
    }
    
    public void clearCart(Long customerId) {
        Optional<Customer> customer = customerRepository.findById(customerId);
        if (customer.isPresent()) {
            cartItemRepository.deleteByCustomer(customer.get());
        }
    }
    
    public void syncCart(Long customerId, List<CartSyncRequest> items) {
        // å…ˆæ¸…ç©ºç°æœ‰è´­ç‰©è½¦
        clearCart(customerId);
        
        // æ·»åŠ æ–°çš„è´­ç‰©è½¦é¡¹
        for (CartSyncRequest item : items) {
            addToCart(customerId, item.getProductId(), item.getQuantity());
        }
    }
}
```

### 4. åˆ›å»ºè´­ç‰©è½¦æ§åˆ¶å™¨

```java
// src/main/java/com/taobao/controller/CartController.java
package com.taobao.controller;

import com.taobao.entity.CartItem;
import com.taobao.service.CartService;
import com.taobao.dto.CartSyncRequest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/cart")
@CrossOrigin(origins = "*")
public class CartController {
    
    @Autowired
    private CartService cartService;
    
    @GetMapping("/{customerId}")
    public ResponseEntity<List<CartItem>> getCartItems(@PathVariable Long customerId) {
        try {
            List<CartItem> items = cartService.getCartItems(customerId);
            return ResponseEntity.ok(items);
        } catch (Exception e) {
            return ResponseEntity.notFound().build();
        }
    }
    
    @PostMapping("/{customerId}/add")
    public ResponseEntity<CartItem> addToCart(
            @PathVariable Long customerId,
            @RequestParam Long productId,
            @RequestParam Integer quantity) {
        try {
            CartItem item = cartService.addToCart(customerId, productId, quantity);
            return ResponseEntity.ok(item);
        } catch (Exception e) {
            return ResponseEntity.badRequest().build();
        }
    }
    
    @PutMapping("/{customerId}/update")
    public ResponseEntity<CartItem> updateCartItem(
            @PathVariable Long customerId,
            @RequestParam Long productId,
            @RequestParam Integer quantity) {
        try {
            CartItem item = cartService.updateCartItem(customerId, productId, quantity);
            return ResponseEntity.ok(item);
        } catch (Exception e) {
            return ResponseEntity.badRequest().build();
        }
    }
    
    @DeleteMapping("/{customerId}/remove")
    public ResponseEntity<Map<String, String>> removeFromCart(
            @PathVariable Long customerId,
            @RequestParam Long productId) {
        try {
            cartService.removeFromCart(customerId, productId);
            Map<String, String> response = new HashMap<>();
            response.put("message", "Item removed from cart");
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            return ResponseEntity.badRequest().build();
        }
    }
    
    @DeleteMapping("/{customerId}/clear")
    public ResponseEntity<Map<String, String>> clearCart(@PathVariable Long customerId) {
        try {
            cartService.clearCart(customerId);
            Map<String, String> response = new HashMap<>();
            response.put("message", "Cart cleared");
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            return ResponseEntity.badRequest().build();
        }
    }
    
    @PostMapping("/{customerId}/sync")
    public ResponseEntity<Map<String, String>> syncCart(
            @PathVariable Long customerId,
            @RequestBody List<CartSyncRequest> items) {
        try {
            cartService.syncCart(customerId, items);
            Map<String, String> response = new HashMap<>();
            response.put("message", "Cart synced successfully");
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            return ResponseEntity.badRequest().build();
        }
    }
}
```

### 5. åˆ›å»ºæ•°æ®ä¼ è¾“å¯¹è±¡

```java
// src/main/java/com/taobao/dto/CartSyncRequest.java
package com.taobao.dto;

public class CartSyncRequest {
    private Long productId;
    private Integer quantity;
    
    public CartSyncRequest() {}
    
    public CartSyncRequest(Long productId, Integer quantity) {
        this.productId = productId;
        this.quantity = quantity;
    }
    
    public Long getProductId() { return productId; }
    public void setProductId(Long productId) { this.productId = productId; }
    
    public Integer getQuantity() { return quantity; }
    public void setQuantity(Integer quantity) { this.quantity = quantity; }
}
```

## ğŸ–¥ï¸ å‰ç«¯å®ç°

### 1. æ›´æ–°Vuex Store

```javascript
// frontend/src/store/index.js æ–°å¢actions
export default new Vuex.Store({
  // ... ç°æœ‰ä»£ç  ...
  
  actions: {
    // ... ç°æœ‰actions ...
    
    // ä»æœåŠ¡å™¨åŠ è½½è´­ç‰©è½¦
    async loadCartFromServer({ commit, state }) {
      if (!state.user) return;
      
      try {
        const response = await axios.get(`/cart/${state.user.id}`);
        const serverCart = response.data.map(item => ({
          id: item.product.id,
          name: item.product.name,
          price: item.product.price,
          image: item.product.imageUrl,
          quantity: item.quantity
        }));
        
        commit('setCart', serverCart);
      } catch (error) {
        console.error('Failed to load cart from server:', error);
      }
    },
    
    // åŒæ­¥è´­ç‰©è½¦åˆ°æœåŠ¡å™¨
    async syncCartToServer({ state }) {
      if (!state.user || state.cart.length === 0) return;
      
      try {
        const cartItems = state.cart.map(item => ({
          productId: item.id,
          quantity: item.quantity
        }));
        
        await axios.post(`/cart/${state.user.id}/sync`, cartItems);
      } catch (error) {
        console.error('Failed to sync cart to server:', error);
      }
    },
    
    // æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦ï¼ˆåŒæ—¶æ›´æ–°æœåŠ¡å™¨ï¼‰
    async addToCartWithSync({ commit, state, dispatch }, { product, quantity }) {
      // å…ˆæ›´æ–°æœ¬åœ°çŠ¶æ€
      commit('addToCart', { product, quantity });
      
      // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼ŒåŒæ­¥åˆ°æœåŠ¡å™¨
      if (state.user) {
        try {
          await axios.post(`/cart/${state.user.id}/add`, null, {
            params: { productId: product.id, quantity }
          });
        } catch (error) {
          console.error('Failed to sync add to cart:', error);
        }
      }
    },
    
    // æ›´æ–°è´­ç‰©è½¦é¡¹ï¼ˆåŒæ—¶æ›´æ–°æœåŠ¡å™¨ï¼‰
    async updateCartItemWithSync({ commit, state }, { id, quantity }) {
      // å…ˆæ›´æ–°æœ¬åœ°çŠ¶æ€
      commit('updateCartItem', { id, quantity });
      
      // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼ŒåŒæ­¥åˆ°æœåŠ¡å™¨
      if (state.user) {
        try {
          await axios.put(`/cart/${state.user.id}/update`, null, {
            params: { productId: id, quantity }
          });
        } catch (error) {
          console.error('Failed to sync update cart:', error);
        }
      }
    },
    
    // ä»è´­ç‰©è½¦ç§»é™¤å•†å“ï¼ˆåŒæ—¶æ›´æ–°æœåŠ¡å™¨ï¼‰
    async removeFromCartWithSync({ commit, state }, productId) {
      // å…ˆæ›´æ–°æœ¬åœ°çŠ¶æ€
      commit('removeCartItem', productId);
      
      // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼ŒåŒæ­¥åˆ°æœåŠ¡å™¨
      if (state.user) {
        try {
          await axios.delete(`/cart/${state.user.id}/remove`, {
            params: { productId }
          });
        } catch (error) {
          console.error('Failed to sync remove from cart:', error);
        }
      }
    }
  },
  
  mutations: {
    // ... ç°æœ‰mutations ...
    
    // è®¾ç½®è´­ç‰©è½¦
    setCart(state, cart) {
      state.cart = cart;
      localStorage.setItem('cart', JSON.stringify(cart));
    }
  }
});
```

### 2. æ›´æ–°ç™»å½•é€»è¾‘

```javascript
// frontend/src/views/Login.vue æ›´æ–°handleLoginæ–¹æ³•
async handleLogin() {
  this.loading = true;
  
  try {
    // æ‰§è¡Œç™»å½•
    const response = await this.$store.dispatch('login', {
      username: this.loginForm.username,
      password: this.loginForm.password
    });
    
    if (response.data.success) {
      // ç™»å½•æˆåŠŸåï¼Œå¤„ç†è´­ç‰©è½¦åŒæ­¥
      const localCart = this.$store.getters.cartItems;
      
      if (localCart.length > 0) {
        // æœ¬åœ°æœ‰è´­ç‰©è½¦æ•°æ®ï¼Œè¯¢é—®ç”¨æˆ·å¦‚ä½•å¤„ç†
        this.$confirm('æ£€æµ‹åˆ°æœ¬åœ°è´­ç‰©è½¦æ•°æ®ï¼Œæ˜¯å¦ä¸æœåŠ¡å™¨è´­ç‰©è½¦åˆå¹¶ï¼Ÿ', 'è´­ç‰©è½¦åŒæ­¥', {
          confirmButtonText: 'åˆå¹¶',
          cancelButtonText: 'ä½¿ç”¨æœåŠ¡å™¨æ•°æ®',
          type: 'info'
        }).then(async () => {
          // ç”¨æˆ·é€‰æ‹©åˆå¹¶ï¼Œå…ˆåŒæ­¥æœ¬åœ°æ•°æ®åˆ°æœåŠ¡å™¨
          await this.$store.dispatch('syncCartToServer');
          this.$message.success('è´­ç‰©è½¦å·²åˆå¹¶');
        }).catch(async () => {
          // ç”¨æˆ·é€‰æ‹©ä½¿ç”¨æœåŠ¡å™¨æ•°æ®
          await this.$store.dispatch('loadCartFromServer');
          this.$message.success('å·²åŠ è½½æœåŠ¡å™¨è´­ç‰©è½¦');
        });
      } else {
        // æœ¬åœ°æ— è´­ç‰©è½¦æ•°æ®ï¼Œç›´æ¥åŠ è½½æœåŠ¡å™¨æ•°æ®
        await this.$store.dispatch('loadCartFromServer');
      }
      
      this.$message.success('ç™»å½•æˆåŠŸ');
      this.$router.push(this.$route.query.redirect || '/');
    }
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥:', error);
    this.$message.error('ç™»å½•å¤±è´¥');
  } finally {
    this.loading = false;
  }
}
```

### 3. æ›´æ–°è´­ç‰©è½¦ç»„ä»¶

```javascript
// frontend/src/views/order/ShoppingCart.vue æ›´æ–°æ–¹æ³•
export default {
  // ... ç°æœ‰ä»£ç  ...
  
  methods: {
    // æ›´æ–°è´­ç‰©è½¦é¡¹æ•°é‡
    updateCartItem(id, quantity) {
      this.$store.dispatch('updateCartItemWithSync', { id, quantity });
    },
    
    // ç§»é™¤è´­ç‰©è½¦é¡¹
    removeCartItem(id) {
      this.$confirm('ç¡®å®šè¦ä»è´­ç‰©è½¦ä¸­åˆ é™¤è¯¥å•†å“å—?', 'æç¤º', {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }).then(() => {
        this.$store.dispatch('removeFromCartWithSync', id);
        this.$message.success('å•†å“å·²ä»è´­ç‰©è½¦ä¸­åˆ é™¤');
      }).catch(() => {});
    },
    
    // æ¸…ç©ºè´­ç‰©è½¦
    async clearCart() {
      if (this.cartItems.length === 0) {
        this.$message.warning('è´­ç‰©è½¦å·²ç»ä¸ºç©º');
        return;
      }
      
      this.$confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—?', 'æç¤º', {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }).then(async () => {
        // æ¸…ç©ºæœ¬åœ°è´­ç‰©è½¦
        this.$store.commit('clearCart');
        
        // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ¸…ç©ºæœåŠ¡å™¨è´­ç‰©è½¦
        const user = this.$store.getters.currentUser;
        if (user) {
          try {
            await this.$http.delete(`/cart/${user.id}/clear`);
          } catch (error) {
            console.error('Failed to clear server cart:', error);
          }
        }
        
        this.$message.success('è´­ç‰©è½¦å·²æ¸…ç©º');
      }).catch(() => {});
    }
  }
};
```

## ğŸ“„ æ•°æ®åº“è„šæœ¬

```sql
-- æ·»åŠ è´­ç‰©è½¦è¡¨åˆ° init_db.sql
CREATE TABLE IF NOT EXISTS cart_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    customer_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
    UNIQUE KEY unique_customer_product (customer_id, product_id)
);

-- æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_cart_customer ON cart_items(customer_id);
CREATE INDEX idx_cart_product ON cart_items(product_id);
```

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

```javascript
// æµ‹è¯•è´­ç‰©è½¦åŒæ­¥åŠŸèƒ½
async function testCartSync() {
  console.log('å¼€å§‹æµ‹è¯•è´­ç‰©è½¦åŒæ­¥åŠŸèƒ½...');
  
  // 1. ç™»å½•ç”¨æˆ·
  await login('user1', 'password1');
  
  // 2. æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
  await addToCart(1, 2); // äº§å“ID 1ï¼Œæ•°é‡ 2
  await addToCart(2, 1); // äº§å“ID 2ï¼Œæ•°é‡ 1
  
  // 3. éªŒè¯è´­ç‰©è½¦å†…å®¹
  const cart = await getCart();
  console.log('è´­ç‰©è½¦å†…å®¹:', cart);
  
  // 4. æ›´æ–°å•†å“æ•°é‡
  await updateCartItem(1, 3);
  
  // 5. ç§»é™¤å•†å“
  await removeFromCart(2);
  
  // 6. éªŒè¯æœ€ç»ˆçŠ¶æ€
  const finalCart = await getCart();
  console.log('æœ€ç»ˆè´­ç‰©è½¦:', finalCart);
}
```

## ğŸ“ æ€»ç»“

é€šè¿‡ä»¥ä¸Šå®ç°ï¼Œè´­ç‰©è½¦æ•°æ®å°†èƒ½å¤Ÿï¼š

1. **è‡ªåŠ¨åŒæ­¥**: ç”¨æˆ·æ“ä½œè´­ç‰©è½¦æ—¶è‡ªåŠ¨åŒæ­¥åˆ°æœåŠ¡å™¨
2. **è·¨è®¾å¤‡è®¿é—®**: ç”¨æˆ·åœ¨ä¸åŒè®¾å¤‡ç™»å½•æ—¶èƒ½çœ‹åˆ°ç›¸åŒçš„è´­ç‰©è½¦
3. **æ•°æ®æŒä¹…åŒ–**: è´­ç‰©è½¦æ•°æ®ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œä¸ä¼šä¸¢å¤±
4. **æ™ºèƒ½åˆå¹¶**: ç™»å½•æ—¶å¯ä»¥é€‰æ‹©åˆå¹¶æœ¬åœ°å’ŒæœåŠ¡å™¨è´­ç‰©è½¦æ•°æ®
5. **æ€§èƒ½ä¼˜åŒ–**: æœ¬åœ°ä¼˜å…ˆæ˜¾ç¤ºï¼Œåå°åŒæ­¥ï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒ

è¿™ä¸ªå®ç°å¤§å¤§æå‡äº†ç”¨æˆ·ä½“éªŒï¼Œä½¿è´­ç‰©è½¦åŠŸèƒ½æ›´åŠ å®Œå–„å’Œå®ç”¨ã€‚ 